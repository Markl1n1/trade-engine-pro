# üîß Settings Persistence & Audit System Plan

## üêõ **–ü–†–û–ë–õ–ï–ú–´**

1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è** - –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î
2. **–ù–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏** - Dashboard –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
3. **–ù–µ—Ç –∞—É–¥–∏—Ç–∞** - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
4. **–ù–µ—Ç –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏** - Audit logs –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è

---

## üéØ **–ü–õ–ê–ù –†–ï–®–ï–ù–ò–Ø**

### **1. üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫**

#### **A. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Settings.tsx:**
- –î–æ–±–∞–≤–∏—Ç—å `trading_mode` –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ä–µ–∂–∏–º–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏
- –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

#### **B. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ user_settings —Ç–∞–±–ª–∏—Ü—ã:**
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
- –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### **2. üìä –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã Audit Log**

#### **A. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã audit_logs:**
```sql
CREATE TABLE public.audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  action_type TEXT NOT NULL, -- 'settings_change', 'strategy_change', 'position_change'
  entity_type TEXT NOT NULL, -- 'user_settings', 'strategy', 'position'
  entity_id UUID, -- ID –∏–∑–º–µ–Ω—è–µ–º–æ–π —Å—É—â–Ω–æ—Å—Ç–∏
  old_values JSONB, -- –°—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  new_values JSONB, -- –ù–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  changed_fields TEXT[], -- –ú–∞—Å—Å–∏–≤ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

#### **B. –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**
- –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ `user_settings` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ `strategies` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
- –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ `positions` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ–∑–∏—Ü–∏–π

### **3. üóëÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏**

#### **A. –°–æ–∑–¥–∞–Ω–∏–µ cron job –¥–ª—è –æ—á–∏—Å—Ç–∫–∏:**
```sql
-- –£–¥–∞–ª–µ–Ω–∏–µ audit logs —Å—Ç–∞—Ä—à–µ 1 –º–µ—Å—è—Ü–∞ –∫–∞–∂–¥—ã–π 1-–≥–æ —á–∏—Å–ª–∞
SELECT cron.schedule(
  'cleanup-audit-logs',
  '0 0 1 * *', -- –ö–∞–∂–¥—ã–π 1-–≥–æ —á–∏—Å–ª–∞ –≤ 00:00
  $$
  DELETE FROM public.audit_logs 
  WHERE created_at < NOW() - INTERVAL '1 month';
  $$
);
```

### **4. üîÑ –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**

#### **A. Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket:**
- –°–æ–∑–¥–∞—Ç—å Edge Function –¥–ª—è broadcast –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –û–±–Ω–æ–≤–ª—è—Ç—å Dashboard –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –£–≤–µ–¥–æ–º–ª—è—Ç—å –¥—Ä—É–≥–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

#### **B. Polling fallback:**
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–∫
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## üöÄ **–≠–¢–ê–ü–´ –†–ï–ê–õ–ò–ó–ê–¶–ò–ò**

### **–≠—Ç–∞–ø 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫**
1. –û–±–Ω–æ–≤–∏—Ç—å Settings.tsx –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è trading_mode
2. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫—É

### **–≠—Ç–∞–ø 2: –°–æ–∑–¥–∞–Ω–∏–µ Audit System**
1. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É audit_logs
2. –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
3. –°–æ–∑–¥–∞—Ç—å UI –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ audit logs
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–≠—Ç–∞–ø 3: –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏**
1. –°–æ–∑–¥–∞—Ç—å cron job –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫—É
3. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—á–∏—Å—Ç–∫–∏

### **–≠—Ç–∞–ø 4: –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**
1. –°–æ–∑–¥–∞—Ç—å WebSocket —Å–∏—Å—Ç–µ–º—É –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
2. –î–æ–±–∞–≤–∏—Ç—å polling fallback
3. –û–±–Ω–æ–≤–∏—Ç—å Dashboard –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é

---

## üìã **–î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù**

### **1. üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Settings.tsx**

#### **–ü—Ä–æ–±–ª–µ–º—ã –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–¥–µ:**
- `trading_mode` –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `handleSave`
- –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–µ–∂–∏–º–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏
- –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

#### **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```typescript
// –î–æ–±–∞–≤–∏—Ç—å trading_mode –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
const settingsData = {
  // ... existing fields
  trading_mode: settings.trading_mode,
  use_mainnet_data: settings.use_mainnet_data,
  use_testnet_api: settings.use_testnet_api,
  paper_trading_mode: settings.paper_trading_mode,
};
```

### **2. üìä –°–æ–∑–¥–∞–Ω–∏–µ Audit System**

#### **A. –ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è audit_logs:**
```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã audit_logs
CREATE TABLE public.audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  action_type TEXT NOT NULL,
  entity_type TEXT NOT NULL,
  entity_id UUID,
  old_values JSONB,
  new_values JSONB,
  changed_fields TEXT[],
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX idx_audit_logs_user_id ON public.audit_logs(user_id);
CREATE INDEX idx_audit_logs_created_at ON public.audit_logs(created_at);
CREATE INDEX idx_audit_logs_entity_type ON public.audit_logs(entity_type);
```

#### **B. –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è user_settings:**
```sql
CREATE OR REPLACE FUNCTION public.audit_user_settings_changes()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.audit_logs (
    user_id, action_type, entity_type, entity_id,
    old_values, new_values, changed_fields
  ) VALUES (
    NEW.user_id, 'settings_change', 'user_settings', NEW.id,
    to_jsonb(OLD), to_jsonb(NEW), 
    ARRAY(SELECT key FROM jsonb_each(to_jsonb(NEW)) WHERE to_jsonb(NEW)->>key != to_jsonb(OLD)->>key)
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER audit_user_settings_trigger
  AFTER UPDATE ON public.user_settings
  FOR EACH ROW
  EXECUTE FUNCTION public.audit_user_settings_changes();
```

### **3. üóëÔ∏è –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏**

#### **Cron job –¥–ª—è –æ—á–∏—Å—Ç–∫–∏:**
```sql
SELECT cron.schedule(
  'cleanup-audit-logs',
  '0 0 1 * *', -- –ö–∞–∂–¥—ã–π 1-–≥–æ —á–∏—Å–ª–∞ –≤ 00:00
  $$
  DELETE FROM public.audit_logs 
  WHERE created_at < NOW() - INTERVAL '1 month';
  
  -- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏
  INSERT INTO public.system_health_logs (service_name, status, message)
  VALUES ('audit_cleanup', 'healthy', 'Audit logs cleaned up successfully');
  $$
);
```

### **4. üîÑ –°–∏—Å—Ç–µ–º–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**

#### **A. WebSocket Edge Function:**
```typescript
// supabase/functions/settings-sync/index.ts
export default async function handler(req: Request) {
  // Broadcast –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Dashboard –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
}
```

#### **B. Polling –≤ Dashboard:**
```typescript
// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–∫
useEffect(() => {
  const interval = setInterval(() => {
    checkSettingsChanges();
  }, 30000); // –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
  
  return () => clearInterval(interval);
}, []);
```

---

## ‚úÖ **–û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´**

### **üéØ –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è** - –†–µ–∂–∏–º —Ç–æ—Ä–≥–æ–≤–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
2. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç** - Dashboard –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
3. **Audit –¥–æ—Å—Ç—É–ø–µ–Ω** - –ú–æ–∂–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π
4. **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞** - –°–∏—Å—Ç–µ–º–∞ –Ω–µ –∑–∞—Å–æ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–º–∏ –ª–æ–≥–∞–º–∏

### **üîß –î–ª—è —Å–∏—Å—Ç–µ–º—ã:**
1. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã
2. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** - –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–æ—Å—Ç—É

---

## üöÄ **–ù–ê–ß–ù–ï–ú –†–ï–ê–õ–ò–ó–ê–¶–ò–Æ!**

–ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å —Å **–≠—Ç–∞–ø–∞ 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫**.
